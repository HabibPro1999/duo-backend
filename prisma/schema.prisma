generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "cockroachdb"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CLIENTS MODULE
// ============================================================================

model Client {
  id           String   @id @default(uuid())
  name         String
  logo         String?
  primaryColor String?  @map("primary_color")
  email        String?
  phone        String?
  active       Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  users          User[]
  events         Event[]
  emailTemplates EmailTemplate[]

  @@map("clients")
}

// ============================================================================
// IDENTITY MODULE
// ============================================================================

model User {
  id        String   @id // Firebase UID
  email     String   @unique
  name      String
  role      Int      @default(1) // 0 = super_admin, 1 = client_admin
  clientId  String?  @map("client_id")
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  client Client? @relation(fields: [clientId], references: [id])

  @@index([clientId])
  @@index([active, role])
  @@map("users")
}

// ============================================================================
// EVENTS MODULE
// ============================================================================

model Event {
  id              String      @id @default(uuid())
  clientId        String      @map("client_id")
  name            String
  slug            String      @unique
  description     String?
  maxCapacity     Int?        @map("max_capacity")
  registeredCount Int         @default(0) @map("registered_count")
  startDate       DateTime    @map("start_date")
  endDate         DateTime    @map("end_date")
  location        String?
  status          EventStatus @default(CLOSED)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  client             Client             @relation(fields: [clientId], references: [id])
  forms              Form[] // Multiple forms per event (REGISTRATION, SPONSOR)
  pricing            EventPricing? // One-to-one: pricing configuration (includes embedded rules)
  access             EventAccess[]
  registrations      Registration[]
  emailTemplates     EmailTemplate[]
  sponsorshipBatches SponsorshipBatch[]
  sponsorships       Sponsorship[]

  @@index([clientId, status])
  @@map("events")
}

enum EventStatus {
  CLOSED // Not accepting registrations (default)
  OPEN // Accepting registrations
  ARCHIVED // Event is over, historical
}

// ============================================================================
// SPONSORSHIP MODULE - ENUMS
// ============================================================================

enum FormType {
  REGISTRATION
  SPONSOR
}

enum SponsorshipStatus {
  PENDING // Created, not yet linked to registration
  USED // Linked to one or more registrations
  CANCELLED // Admin cancelled
}

// ============================================================================
// FORMS MODULE
// ============================================================================

model Form {
  id             String   @id @default(uuid())
  eventId        String   @map("event_id")
  type           FormType @default(REGISTRATION)
  name           String
  schema         Json
  schemaVersion  Int      @default(1) @map("schema_version")
  successTitle   String?  @map("success_title")
  successMessage String?  @map("success_message")
  active         Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  event              Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)
  registrations      Registration[]
  sponsorshipBatches SponsorshipBatch[]

  @@unique([eventId, type]) // One form per type per event
  @@index([eventId])
  @@map("forms")
}

// ============================================================================
// PRICING MODULE
// ============================================================================

// Event pricing configuration: base price, currency, embedded rules, and payment methods
model EventPricing {
  id        String @id @default(uuid())
  eventId   String @unique @map("event_id")
  basePrice Int    @default(0) @map("base_price")
  currency  String @default("TND")
  rules     Json   @default("[]") // Embedded pricing rules array

  // Payment Methods
  onlinePaymentEnabled Boolean @default(false) @map("online_payment_enabled")
  onlinePaymentUrl     String? @map("online_payment_url")

  // Bank Transfer Details (bank transfer is always enabled)
  bankName          String? @map("bank_name")
  bankAccountName   String? @map("bank_account_name")
  bankAccountNumber String? @map("bank_account_number")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_pricing")
}

// ============================================================================
// ACCESS MODULE
// ============================================================================

enum AccessType {
  WORKSHOP
  DINNER
  SESSION
  NETWORKING
  ACCOMMODATION
  TRANSPORT
  OTHER
}

model EventAccess {
  id      String @id @default(uuid())
  eventId String @map("event_id")

  // Type categorization
  type AccessType @default(OTHER)

  // Basic info
  name        String
  description String?
  location    String?

  // Session scheduling (for time-based grouping)
  startsAt DateTime? @map("starts_at")
  endsAt   DateTime? @map("ends_at")

  // Pricing
  price    Int    @default(0)
  currency String @default("TND")

  // Capacity
  maxCapacity     Int? @map("max_capacity")
  registeredCount Int  @default(0) @map("registered_count")

  // Availability window (when can people select this)
  availableFrom DateTime? @map("available_from")
  availableTo   DateTime? @map("available_to")

  // Conditions (form-based prerequisites)
  conditions     Json? // Array of {fieldId, operator, value}
  conditionLogic String @default("AND") @map("condition_logic")

  // Display
  sortOrder Int     @default(0) @map("sort_order")
  active    Boolean @default(true)

  // Custom grouping (for OTHER type - allows custom group labels like "Excursions")
  groupLabel String? @map("group_label")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  event           Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  requiredAccess  EventAccess[] @relation("AccessPrerequisites")
  prerequisiteFor EventAccess[] @relation("AccessPrerequisites")

  @@index([eventId, startsAt])
  @@index([eventId, type])
  @@index([eventId, active])
  @@map("event_access")
}

// ============================================================================
// SPONSORSHIP MODULE
// ============================================================================

model SponsorshipBatch {
  id          String   @id @default(uuid())
  eventId     String   @map("event_id")
  formId      String   @map("form_id")

  // Sponsor (Lab) Information
  labName     String   @map("lab_name")
  contactName String   @map("contact_name")
  email       String
  phone       String?

  // Full form submission (includes custom fields)
  formData    Json     @map("form_data")

  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  event        Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  form         Form          @relation(fields: [formId], references: [id], onDelete: Cascade)
  sponsorships Sponsorship[]

  @@index([eventId])
  @@index([email])
  @@map("sponsorship_batches")
}

model Sponsorship {
  id                 String            @id @default(uuid())
  batchId            String            @map("batch_id")
  eventId            String            @map("event_id")

  // Unique code (admin-only visible)
  code               String            @unique
  status             SponsorshipStatus @default(PENDING)

  // Beneficiary Information
  beneficiaryName    String            @map("beneficiary_name")
  beneficiaryEmail   String            @map("beneficiary_email")
  beneficiaryPhone   String?           @map("beneficiary_phone")
  beneficiaryAddress String?           @map("beneficiary_address")

  // Coverage
  coversBasePrice    Boolean           @default(true) @map("covers_base_price")
  coveredAccessIds   String[]          @default([]) @map("covered_access_ids") // Array of EventAccess IDs
  totalAmount        Int               @map("total_amount") // Calculated: base (if covered) + sum(access prices)

  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")

  // Relations
  batch  SponsorshipBatch   @relation(fields: [batchId], references: [id], onDelete: Cascade)
  event  Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)
  usages SponsorshipUsage[]

  @@index([eventId])
  @@index([batchId])
  @@index([code])
  @@index([status])
  @@index([beneficiaryEmail])
  @@map("sponsorships")
}

model SponsorshipUsage {
  id             String   @id @default(uuid())
  sponsorshipId  String   @map("sponsorship_id")
  registrationId String   @map("registration_id")

  amountApplied  Int      @map("amount_applied") // How much from this sponsorship was applied
  appliedAt      DateTime @default(now()) @map("applied_at")
  appliedBy      String   @map("applied_by") // User ID who linked it

  // Relations
  sponsorship  Sponsorship  @relation(fields: [sponsorshipId], references: [id], onDelete: Cascade)
  registration Registration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  @@unique([sponsorshipId, registrationId]) // One link per pair
  @@index([registrationId])
  @@map("sponsorship_usages")
}

// ============================================================================
// REGISTRATIONS MODULE
// ============================================================================

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  WAIVED
}

enum PaymentMethod {
  BANK_TRANSFER
  ONLINE
  CASH
}

model Registration {
  id      String @id @default(uuid())
  formId  String @map("form_id")
  eventId String @map("event_id")

  // Submission data
  formData    Json     @map("form_data")
  submittedAt DateTime @default(now()) @map("submitted_at")

  // Form schema versioning
  formSchemaVersion Int @default(1) @map("form_schema_version")

  // Denormalized registrant info (for quick access)
  email     String
  firstName String? @map("first_name")
  lastName  String? @map("last_name")
  phone     String?

  // Status (PaymentStatus is the single source of truth)
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")

  // Payment
  totalAmount      Int            @map("total_amount")
  paidAmount       Int            @default(0) @map("paid_amount")
  currency         String         @default("TND")
  paymentMethod    PaymentMethod? @map("payment_method")
  paymentReference String?        @map("payment_reference")
  paymentProofUrl  String?        @map("payment_proof_url")

  // Price breakdown (stored for audit)
  priceBreakdown Json @map("price_breakdown")

  // Denormalized financial columns (for aggregation/reporting)
  baseAmount     Int @default(0) @map("base_amount")
  discountAmount Int @default(0) @map("discount_amount")
  accessAmount   Int @default(0) @map("access_amount")

  // Sponsorship
  sponsorshipCode   String? @map("sponsorship_code")
  sponsorshipAmount Int     @default(0) @map("sponsorship_amount")

  // Timestamps
  paidAt    DateTime? @map("paid_at")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Self-service editing timestamp
  lastEditedAt DateTime? @map("last_edited_at")

  // Self-service edit token (for secure public edit access)
  editToken       String?   @unique @map("edit_token")
  editTokenExpiry DateTime? @map("edit_token_expiry")

  // Idempotency key for safe retries
  idempotencyKey String? @unique @map("idempotency_key")

  // Admin note (single text field)
  note String?

  // Access type IDs (simple array for querying)
  accessTypeIds String[] @default([]) @map("access_type_ids")

  // Relations
  form              Form               @relation(fields: [formId], references: [id], onDelete: Cascade)
  event             Event              @relation(fields: [eventId], references: [id])
  emailLogs         EmailLog[]
  sponsorshipUsages SponsorshipUsage[]

  @@unique([email, formId])
  @@index([eventId, paymentStatus])
  @@index([eventId, submittedAt])
  @@index([eventId, paidAt])
  @@index([formId])
  @@index([email])
  @@index([sponsorshipCode])
  @@map("registrations")
}

// ============================================================================
// EMAIL MODULE
// ============================================================================

enum EmailTemplateCategory {
  AUTOMATIC // Triggered by system events
  MANUAL // Used for admin-initiated campaigns
}

enum AutomaticEmailTrigger {
  REGISTRATION_CREATED // When registration form is submitted
  PAYMENT_PROOF_SUBMITTED // When user uploads payment proof
  PAYMENT_CONFIRMED // When admin confirms/validates payment
}

enum EmailStatus {
  QUEUED // In queue, waiting to be processed
  SENDING // Currently being sent to SendGrid
  SENT // Accepted by SendGrid
  DELIVERED // Confirmed delivery (webhook)
  OPENED // Recipient opened (webhook)
  CLICKED // Recipient clicked link (webhook)
  BOUNCED // Delivery failed (webhook)
  DROPPED // SendGrid dropped (spam, invalid)
  FAILED // Error during sending
  SKIPPED // Skipped (e.g., no template found)
}

model EmailTemplate {
  id          String   @id @default(uuid())
  clientId    String   @map("client_id")

  // Template identification
  name        String // "Welcome Email", "Payment Confirmation"
  description String? // Admin notes about this template

  // Content
  subject     String // Email subject (can contain {{variables}})
  content     Json // Tiptap editor JSON document

  // Pre-compiled content (cached on save for performance)
  mjmlContent  String? @map("mjml_content") // Generated MJML markup
  htmlContent  String? @map("html_content") // Compiled responsive HTML
  plainContent String? @map("plain_content") // Plain text version

  // Template categorization
  category EmailTemplateCategory // AUTOMATIC or MANUAL

  // For AUTOMATIC templates: which system event triggers this
  trigger AutomaticEmailTrigger? // REGISTRATION_CREATED, etc.

  // Scope: event-specific or client-wide
  eventId String? @map("event_id") // NULL = available for all client's events

  // Metadata
  isDefault Boolean @default(false) @map("is_default") // System default template (fallback)
  isActive  Boolean @default(true) @map("is_active") // Can be disabled without deletion

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  client    Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  event     Event?     @relation(fields: [eventId], references: [id], onDelete: SetNull)
  emailLogs EmailLog[]

  // Constraints
  @@unique([clientId, trigger, eventId]) // One template per trigger per event
  @@index([clientId, category])
  @@index([clientId, trigger])
  @@index([eventId])
  @@map("email_templates")
}

model EmailLog {
  id String @id @default(uuid())

  // Source identification
  trigger AutomaticEmailTrigger? // If from automatic trigger (null = manual send)

  // Template used
  templateId String? @map("template_id")

  // Target
  registrationId String? @map("registration_id")
  recipientEmail String  @map("recipient_email")
  recipientName  String? @map("recipient_name")

  // Content snapshot (for audit/debugging)
  subject String

  // Delivery tracking
  status EmailStatus @default(QUEUED)

  // SendGrid integration
  sendgridMessageId String? @map("sendgrid_message_id") // For tracking via webhooks

  // Error handling
  errorMessage String? @map("error_message")
  retryCount   Int     @default(0) @map("retry_count")
  maxRetries   Int     @default(3) @map("max_retries")

  // Variable context (snapshot for debugging/retry)
  contextSnapshot Json? @map("context_snapshot")

  // Timestamps
  queuedAt    DateTime  @default(now()) @map("queued_at")
  updatedAt   DateTime  @updatedAt @map("updated_at") // For backoff timing
  sentAt      DateTime? @map("sent_at")
  deliveredAt DateTime? @map("delivered_at") // From SendGrid webhook
  openedAt    DateTime? @map("opened_at") // From SendGrid webhook
  clickedAt   DateTime? @map("clicked_at") // From SendGrid webhook
  bouncedAt   DateTime? @map("bounced_at") // From SendGrid webhook
  failedAt    DateTime? @map("failed_at")

  // Relations
  template     EmailTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  registration Registration?  @relation(fields: [registrationId], references: [id], onDelete: SetNull)

  // Indexes
  @@index([registrationId])
  @@index([status, queuedAt]) // For queue processing
  @@index([recipientEmail])
  @@index([sendgridMessageId]) // For webhook lookups
  @@index([trigger, queuedAt])
  @@map("email_logs")
}

// ============================================================================
// AUDIT MODULE
// ============================================================================

model AuditLog {
  id          String   @id @default(uuid())
  entityType  String   @map("entity_type") // 'Registration', 'Event', etc.
  entityId    String   @map("entity_id")
  action      String // 'CREATE', 'UPDATE', 'DELETE', 'PAYMENT_CONFIRMED', etc.
  changes     Json? // { field: { old, new } }
  performedBy String?  @map("performed_by") // User ID, 'SYSTEM', or 'PUBLIC'
  performedAt DateTime @default(now()) @map("performed_at")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")

  @@index([entityType, entityId])
  @@index([performedBy])
  @@index([performedAt])
  @@map("audit_logs")
}
