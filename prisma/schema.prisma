generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "cockroachdb"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CLIENTS MODULE
// ============================================================================

model Client {
  id           String   @id @default(uuid())
  name         String
  logo         String?
  primaryColor String?  @map("primary_color")
  email        String?
  phone        String?
  active       Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  users        User[]
  events       Event[]

  @@map("clients")
}

// ============================================================================
// IDENTITY MODULE
// ============================================================================

model User {
  id        String   @id // Firebase UID
  email     String   @unique
  name      String
  role      Int      @default(1) // 0 = super_admin, 1 = client_admin
  clientId  String?  @map("client_id")
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  client            Client?            @relation(fields: [clientId], references: [id])

  @@index([clientId])
  @@index([active, role])
  @@map("users")
}

// ============================================================================
// EVENTS MODULE
// ============================================================================

model Event {
  id              String         @id @default(uuid())
  clientId        String         @map("client_id")
  name            String
  slug            String         @unique
  description     String?
  maxCapacity     Int?           @map("max_capacity")
  registeredCount Int            @default(0) @map("registered_count")
  startDate       DateTime       @map("start_date")
  endDate         DateTime       @map("end_date")
  location        String?
  status          EventStatus    @default(CLOSED)

  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  client          Client         @relation(fields: [clientId], references: [id])
  form            Form?          // One-to-one: each event has exactly one form
  pricing         EventPricing?  // One-to-one: pricing configuration (includes embedded rules)
  access          EventAccess[]
  registrations   Registration[]

  @@index([clientId, status])
  @@map("events")
}

enum EventStatus {
  CLOSED    // Not accepting registrations (default)
  OPEN      // Accepting registrations
  ARCHIVED  // Event is over, historical
}

// ============================================================================
// FORMS MODULE
// ============================================================================

model Form {
  id              String         @id @default(uuid())
  eventId         String         @unique @map("event_id") // One form per event
  name            String
  schema          Json
  schemaVersion   Int            @default(1) @map("schema_version")
  successTitle    String?        @map("success_title")
  successMessage  String?        @map("success_message")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  event           Event          @relation(fields: [eventId], references: [id])
  registrations   Registration[]

  @@index([eventId])
  @@map("forms")
}

// ============================================================================
// PRICING MODULE
// ============================================================================

// Event pricing configuration: base price, currency, embedded rules, and payment methods
model EventPricing {
  id        String   @id @default(uuid())
  eventId   String   @unique @map("event_id")
  basePrice Int      @default(0) @map("base_price")
  currency  String   @default("TND")
  rules     Json     @default("[]") // Embedded pricing rules array

  // Payment Methods
  onlinePaymentEnabled Boolean  @default(false) @map("online_payment_enabled")
  onlinePaymentUrl     String?  @map("online_payment_url")

  // Bank Transfer Details (bank transfer is always enabled)
  bankName          String?  @map("bank_name")
  bankAccountName   String?  @map("bank_account_name")
  bankAccountNumber String?  @map("bank_account_number")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_pricing")
}

// ============================================================================
// ACCESS MODULE
// ============================================================================

enum AccessType {
  WORKSHOP
  DINNER
  SESSION
  NETWORKING
  ACCOMMODATION
  TRANSPORT
  OTHER
}

model EventAccess {
  id              String       @id @default(uuid())
  eventId         String       @map("event_id")

  // Type categorization
  type            AccessType   @default(OTHER)

  // Basic info
  name            String
  description     String?
  location        String?

  // Session scheduling (for time-based grouping)
  startsAt        DateTime?    @map("starts_at")
  endsAt          DateTime?    @map("ends_at")

  // Pricing
  price           Int          @default(0)
  currency        String       @default("TND")

  // Capacity
  maxCapacity     Int?         @map("max_capacity")
  registeredCount Int          @default(0) @map("registered_count")

  // Availability window (when can people select this)
  availableFrom   DateTime?    @map("available_from")
  availableTo     DateTime?    @map("available_to")

  // Conditions (form-based prerequisites)
  conditions      Json?        // Array of {fieldId, operator, value}
  conditionLogic  String       @default("AND") @map("condition_logic")

  // Display
  sortOrder       Int          @default(0) @map("sort_order")
  active          Boolean      @default(true)

  // Custom grouping (for OTHER type - allows custom group labels like "Excursions")
  groupLabel      String?      @map("group_label")

  // Timestamps
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  // Relations
  event              Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)
  requiredAccess     EventAccess[]      @relation("AccessPrerequisites")
  prerequisiteFor    EventAccess[]      @relation("AccessPrerequisites")

  @@index([eventId, startsAt])
  @@index([eventId, type])
  @@index([eventId, active])
  @@map("event_access")
}

// ============================================================================
// REGISTRATIONS MODULE
// ============================================================================

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  WAIVED
}

enum PaymentMethod {
  BANK_TRANSFER
  ONLINE
  CASH
}

model Registration {
  id                String             @id @default(uuid())
  formId            String             @map("form_id")
  eventId           String             @map("event_id")

  // Submission data
  formData          Json               @map("form_data")
  submittedAt       DateTime           @default(now()) @map("submitted_at")

  // Form schema versioning
  formSchemaVersion Int                @default(1) @map("form_schema_version")

  // Denormalized registrant info (for quick access)
  email             String
  firstName         String?            @map("first_name")
  lastName          String?            @map("last_name")
  phone             String?

  // Status (PaymentStatus is the single source of truth)
  paymentStatus     PaymentStatus      @default(PENDING) @map("payment_status")

  // Payment
  totalAmount       Int                @map("total_amount")
  paidAmount        Int                @default(0) @map("paid_amount")
  currency          String             @default("TND")
  paymentMethod     PaymentMethod?     @map("payment_method")
  paymentReference  String?            @map("payment_reference")
  paymentProofUrl   String?            @map("payment_proof_url")

  // Price breakdown (stored for audit)
  priceBreakdown    Json               @map("price_breakdown")

  // Denormalized financial columns (for aggregation/reporting)
  baseAmount        Int                @default(0) @map("base_amount")
  discountAmount    Int                @default(0) @map("discount_amount")
  accessAmount      Int                @default(0) @map("access_amount")

  // Sponsorship
  sponsorshipCode   String?            @map("sponsorship_code")
  sponsorshipAmount Int                @default(0) @map("sponsorship_amount")

  // Timestamps
  paidAt            DateTime?          @map("paid_at")
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")

  // Self-service editing timestamp
  lastEditedAt        DateTime?        @map("last_edited_at")

  // Admin note (single text field)
  note              String?

  // Access type IDs (simple array for querying)
  accessTypeIds     String[]           @default([]) @map("access_type_ids")

  // Relations
  form              Form               @relation(fields: [formId], references: [id])
  event             Event              @relation(fields: [eventId], references: [id])

  @@unique([email, eventId])
  @@index([eventId, paymentStatus])
  @@index([eventId, submittedAt])
  @@index([eventId, paidAt])
  @@index([formId])
  @@index([email])
  @@index([sponsorshipCode])
  @@map("registrations")
}

