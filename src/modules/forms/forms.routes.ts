import { requireAuth, canAccessClient } from '@shared/middleware/auth.middleware.js';
import { getEventById, EventIdParamSchema } from '@events';
import {
  createForm,
  getFormById,
  listForms,
  updateForm,
  deleteForm,
  getFormClientId,
  getSponsorFormByEventId,
  createSponsorForm,
} from './forms.service.js';
import {
  CreateFormSchema,
  UpdateFormSchema,
  ListFormsQuerySchema,
  FormIdParamSchema,
  type CreateFormInput,
  type UpdateFormInput,
  type ListFormsQuery,
} from './forms.schema.js';
import type { AppInstance } from '@shared/types/fastify.js';
import { UserRole } from '@identity';

export async function formsRoutes(app: AppInstance): Promise<void> {
  // All routes require authentication
  app.addHook('onRequest', requireAuth);

  // POST /api/forms - Create form
  app.post<{ Body: CreateFormInput }>(
    '/',
    {
      schema: { body: CreateFormSchema },
    },
    async (request, reply) => {
      // Get event to check ownership
      const event = await getEventById(request.body.eventId);
      if (!event) {
        throw app.httpErrors.notFound('Event not found');
      }

      // Check if user is super_admin or creating form for their own client's event
      if (!canAccessClient(request.user!, event.clientId)) {
        throw app.httpErrors.forbidden('Insufficient permissions to create form for this event');
      }

      const form = await createForm(request.body);
      return reply.status(201).send(form);
    }
  );

  // GET /api/forms - List forms
  app.get<{ Querystring: ListFormsQuery }>(
    '/',
    {
      schema: { querystring: ListFormsQuerySchema },
    },
    async (request, reply) => {
      const query = { ...request.query };

      // For client_admin users, filter by their client's events
      if (request.user!.role === UserRole.CLIENT_ADMIN) {
        if (!request.user!.clientId) {
          throw app.httpErrors.badRequest('User is not associated with any client');
        }

        // If eventId is provided, verify it belongs to this client
        if (query.eventId) {
          const event = await getEventById(query.eventId);
          if (!event || event.clientId !== request.user!.clientId) {
            throw app.httpErrors.forbidden('Insufficient permissions to access this event');
          }
        }
        // If no eventId provided, we require it for client_admin users
        else {
          throw app.httpErrors.badRequest('Event ID is required for client admin users');
        }
      }

      const result = await listForms(query);
      return reply.send(result);
    }
  );

  // GET /api/forms/:id - Get form
  app.get<{ Params: { id: string } }>(
    '/:id',
    {
      schema: { params: FormIdParamSchema },
    },
    async (request, reply) => {
      const form = await getFormById(request.params.id);
      if (!form) {
        throw app.httpErrors.notFound('Form not found');
      }

      // Check if user is super_admin or accessing their own client's form
      const clientId = await getFormClientId(request.params.id);
      if (clientId && !canAccessClient(request.user!, clientId)) {
        throw app.httpErrors.forbidden('Insufficient permissions to access this form');
      }

      return reply.send(form);
    }
  );

  // PATCH /api/forms/:id - Update form
  app.patch<{ Params: { id: string }; Body: UpdateFormInput }>(
    '/:id',
    {
      schema: { params: FormIdParamSchema, body: UpdateFormSchema },
    },
    async (request, reply) => {
      // Get form to check ownership
      const form = await getFormById(request.params.id);
      if (!form) {
        throw app.httpErrors.notFound('Form not found');
      }

      // Check if user is super_admin or updating their own client's form
      const clientId = await getFormClientId(request.params.id);
      if (clientId && !canAccessClient(request.user!, clientId)) {
        throw app.httpErrors.forbidden('Insufficient permissions to update this form');
      }

      const updatedForm = await updateForm(request.params.id, request.body);
      return reply.send(updatedForm);
    }
  );

  // DELETE /api/forms/:id - Delete form
  app.delete<{ Params: { id: string } }>(
    '/:id',
    {
      schema: { params: FormIdParamSchema },
    },
    async (request, reply) => {
      // Get form to check ownership
      const form = await getFormById(request.params.id);
      if (!form) {
        throw app.httpErrors.notFound('Form not found');
      }

      // Check if user is super_admin or deleting their own client's form
      const clientId = await getFormClientId(request.params.id);
      if (clientId && !canAccessClient(request.user!, clientId)) {
        throw app.httpErrors.forbidden('Insufficient permissions to delete this form');
      }

      await deleteForm(request.params.id);
      return reply.status(204).send();
    }
  );

  // ============================================================================
  // Sponsor Form Routes
  // ============================================================================

  // GET /api/forms/events/:id/sponsor - Get sponsor form for event
  app.get<{ Params: { id: string } }>(
    '/events/:id/sponsor',
    {
      schema: { params: EventIdParamSchema },
    },
    async (request, reply) => {
      // Get event to check ownership
      const event = await getEventById(request.params.id);
      if (!event) {
        throw app.httpErrors.notFound('Event not found');
      }

      // Check if user is super_admin or accessing their own client's event
      if (!canAccessClient(request.user!, event.clientId)) {
        throw app.httpErrors.forbidden('Insufficient permissions to access this event');
      }

      const form = await getSponsorFormByEventId(request.params.id);
      if (!form) {
        throw app.httpErrors.notFound('Sponsor form not found for this event');
      }

      return reply.send(form);
    }
  );

  // POST /api/forms/events/:id/sponsor - Create sponsor form for event
  app.post<{ Params: { id: string }; Body: { name?: string } }>(
    '/events/:id/sponsor',
    {
      schema: { params: EventIdParamSchema },
    },
    async (request, reply) => {
      // Get event to check ownership
      const event = await getEventById(request.params.id);
      if (!event) {
        throw app.httpErrors.notFound('Event not found');
      }

      // Check if user is super_admin or creating form for their own client's event
      if (!canAccessClient(request.user!, event.clientId)) {
        throw app.httpErrors.forbidden('Insufficient permissions to create form for this event');
      }

      const form = await createSponsorForm(request.params.id, request.body?.name);
      return reply.status(201).send(form);
    }
  );
}
