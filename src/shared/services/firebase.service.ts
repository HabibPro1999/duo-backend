import admin from 'firebase-admin';
import type { Auth } from 'firebase-admin/auth';
import type { Storage } from 'firebase-admin/storage';
import { config } from '@config/app.config.js';

// Initialize Firebase Admin SDK
// Uses FIREBASE_SERVICE_ACCOUNT env var (Base64-encoded JSON) or falls back to GOOGLE_APPLICATION_CREDENTIALS
function getCredential() {
  if (config.firebase.serviceAccount) {
    // Decode Base64 to JSON string, then parse
    const jsonString = Buffer.from(config.firebase.serviceAccount, 'base64').toString('utf-8');
    const serviceAccount = JSON.parse(jsonString);
    return admin.credential.cert(serviceAccount);
  }
  // Fallback to application default (GOOGLE_APPLICATION_CREDENTIALS file path)
  return admin.credential.applicationDefault();
}

const app = admin.initializeApp({
  credential: getCredential(),
  storageBucket: config.firebase.storageBucket,
});

// Explicit type annotations fix TypeScript inference error
export const firebaseAuth: Auth = app.auth();
export const firebaseStorage: Storage = app.storage();

/**
 * Verify Firebase ID token and return decoded token.
 */
export async function verifyToken(idToken: string) {
  return firebaseAuth.verifyIdToken(idToken);
}

/**
 * Create a new Firebase Auth user.
 */
export async function createFirebaseUser(email: string, password: string) {
  return firebaseAuth.createUser({
    email,
    password,
    emailVerified: true, // Admin-created accounts are pre-verified
  });
}

/**
 * Set custom claims on a Firebase user (role + clientId).
 */
export async function setCustomClaims(
  uid: string,
  claims: Record<string, unknown>
): Promise<void> {
  await firebaseAuth.setCustomUserClaims(uid, claims);
}

/**
 * Delete a Firebase Auth user.
 */
export async function deleteFirebaseUser(uid: string): Promise<void> {
  await firebaseAuth.deleteUser(uid);
}

/**
 * Upload a file to Firebase Storage and return public URL.
 */
export async function uploadFile(
  buffer: Buffer,
  path: string,
  contentType: string
): Promise<string> {
  const bucket = firebaseStorage.bucket();
  const file = bucket.file(path);

  await file.save(buffer, {
    contentType,
    metadata: { cacheControl: 'public, max-age=31536000' },
  });

  await file.makePublic();
  return file.publicUrl();
}
